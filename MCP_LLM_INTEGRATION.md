# Интеграция MCP сервера с LLM

Этот документ описывает, как MCP сервер NewsAPI интегрирован с LLM моделью (DeepSeek) в приложении.

## Как это работает

1. **Инициализация**: При запуске приложения `ChatViewModel` создает MCP клиент и подключается к NewsAPI MCP серверу (по умолчанию `http://10.0.2.2:3001` для эмулятора).

2. **Получение инструментов**: `McpIntegrationService` получает список доступных MCP инструментов и преобразует их в формат, понятный LLM API (function calling).

3. **Обработка запросов пользователя**:
   - Пользователь отправляет сообщение (например, "Найди новости о технологиях")
   - `DeepSeekService` отправляет запрос к LLM с доступными инструментами
   - LLM анализирует запрос и решает, нужно ли вызвать инструмент
   - Если нужно, LLM возвращает `tool_calls` с указанием, какой инструмент вызвать и с какими параметрами

4. **Вызов инструментов**:
   - `DeepSeekService` получает `tool_calls` от LLM
   - Для каждого вызова инструмента:
     - Вызывается `McpIntegrationService.callTool()` 
     - Который в свою очередь вызывает `McpClient.callTool()`
     - MCP клиент отправляет JSON-RPC запрос к MCP серверу
     - MCP сервер выполняет запрос к NewsAPI
     - Результат возвращается обратно

5. **Финальный ответ**:
   - Результаты вызова инструментов добавляются в историю сообщений
   - LLM получает результаты и формирует финальный ответ пользователю
   - Ответ отображается в UI

## Архитектура

```
Пользователь
    ↓
ChatViewModel
    ↓
DeepSeekService (LLM)
    ↓ (если нужны инструменты)
McpIntegrationService
    ↓
McpClient
    ↓ (HTTP/stdio)
MCP Server (Kotlin)
    ↓ (HTTPS)
NewsAPI (newsapi.org)
```

## Доступные инструменты

После подключения к MCP серверу, LLM может использовать следующие инструменты:

1. **search_news** - Поиск новостных статей по ключевым словам
   - Параметры: q (обязательно), from, to, sortBy, language, page, pageSize

2. **get_top_headlines** - Получение топ новостных заголовков
   - Параметры: country, category, sources, q, page, pageSize

3. **get_sources** - Получение списка источников новостей
   - Параметры: category, language, country

4. **reminder** - Управление напоминаниями о новостях
   - Параметры: action (start/stop/status/get), interval (секунды, по умолчанию 40)
   - Запускает фоновую задачу, которая каждые 40 секунд собирает новости из разных стран
   - При вызове с action="get" возвращает сырые данные новостей в формате JSON
   - **LLM обрабатывает эти данные и создает summary** на основе новостей и предыдущих ответов

## Пример использования

### Пример 1: Поиск новостей

**Пользователь**: "Найди новости о технологиях за последнюю неделю"

**Процесс**:
1. LLM анализирует запрос и решает вызвать `search_news`
2. Формирует параметры: `{ "q": "технологии", "sortBy": "publishedAt" }`
3. Вызывается MCP инструмент, который делает запрос к NewsAPI
4. LLM получает результаты и формирует ответ:
   "Вот последние новости о технологиях..."

### Пример 2: Запуск reminder с автоматической отправкой новостей

**Пользователь**: "Запусти напоминания о новостях каждые 40 секунд"

**Процесс**:
1. LLM анализирует запрос и решает вызвать `reminder`
2. Формирует параметры: `{ "action": "start", "interval": 40 }`
3. MCP сервер запускает фоновую задачу, которая каждые 40 секунд:
   - Получает новости из 3 случайных стран (из списка: us, ru, gb, de, fr, jp, cn, in, br, au)
   - Сохраняет сырые данные новостей в памяти
4. LLM получает подтверждение о запуске reminder
5. **Android приложение автоматически обнаруживает запуск reminder** и начинает периодическую проверку:
   - Каждые 40 секунд вызывает `reminder` с `action="get"`
   - Получает сырые данные новостей в формате JSON
   - Отправляет данные в LLM для создания summary
   - LLM создает summary и **автоматически отправляет ее пользователю** в чат

**Автоматическая работа**:
- После запуска reminder, Android приложение автоматически начинает получать и отправлять новости каждые 40 секунд
- Пользователь получает summary новостей без необходимости запрашивать их вручную
- Summary создается LLM на основе сырых данных от MCP сервера
- Процесс продолжается до тех пор, пока reminder не будет остановлен

**Остановка reminder**:

**Пользователь**: "Останови reminder"

**Процесс**:
1. LLM вызывает `reminder` с параметрами: `{ "action": "stop" }`
2. MCP сервер останавливает фоновую задачу
3. Android приложение автоматически прекращает периодическую проверку

## Настройка

### Изменение URL MCP сервера

По умолчанию используется `http://10.0.2.2:3001` (для эмулятора Android).

Для реального устройства измените URL в `ChatViewModel.kt`:

```kotlin
private val mcpClient = McpClient(
    transport = McpTransport.Http(url = "http://YOUR_IP:3001")
)
```

### Запуск MCP сервера

Перед использованием приложения убедитесь, что MCP сервер запущен:

```bash
./start-newsapi-mcp-kotlin.sh
```

Или через npm:

```bash
npm run start:newsapi:kotlin
```

Подробнее см. [KOTLIN_MCP_SERVER.md](KOTLIN_MCP_SERVER.md)

## Отладка

Все вызовы инструментов логируются. Проверьте логи Android Studio для отладки:

- `DeepSeekService` - логи вызовов LLM и инструментов
- `McpIntegrationService` - логи преобразования инструментов
- `McpClient` - логи MCP запросов

## Ограничения

- Максимальное количество итераций вызова инструментов: 5
- Если MCP сервер недоступен, приложение продолжит работать, но без доступа к инструментам
- Таймаут запросов к MCP серверу: 60 секунд

